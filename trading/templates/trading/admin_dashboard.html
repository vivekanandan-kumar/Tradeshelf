{% extends 'trading/base.html' %}
{% load static %}

{% block title %}Dashboard - TradeShelf{% endblock %}

{% block content %}
<div class="fade-in">
    <!-- Welcome Header -->
    <div class="mb-8">
        <h1 class="text-3xl font-bold text-gray-800 mb-2">Welcome to TradeShelf Dashboard</h1>
        <p class="text-gray-600">Real-time trading analysis and level monitoring</p>
    </div>

    <!-- Stats Cards -->
    <div class="grid grid-cols-1 md:grid-cols-4 gap-6 mb-8">
        <!-- Camarilla Card -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-teal-500 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Camarilla Levels</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2">{{ camarilla_count }}</p>
                    <p class="text-xs text-gray-500 mt-1">Today's Levels</p>
                </div>
                <div class="bg-teal-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-teal-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                    </svg>
                </div>
            </div>
            {% if latest_camarilla %}
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-500">Last Run:</span>
                    <span class="text-xs font-medium 
                        {% if latest_camarilla.status == 'SUCCESS' %}text-green-600
                        {% elif latest_camarilla.status == 'FAILED' %}text-red-600
                        {% else %}text-yellow-600{% endif %}">
                        {{ latest_camarilla.status }}
                    </span>
                </div>
                <p class="text-xs text-gray-400 mt-1">{{ latest_camarilla.start_time|date:"M d, Y H:i" }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Whole Numbers Card -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-blue-500 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Whole Numbers</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2">{{ whole_num_count }}</p>
                    <p class="text-xs text-gray-500 mt-1">Stocks Found</p>
                </div>
                <div class="bg-blue-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-blue-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                    </svg>
                </div>
            </div>
            {% if latest_whole_num %}
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="flex justify-between items-center">
                    <span class="text-xs text-gray-500">Last Run:</span>
                    <span class="text-xs font-medium 
                        {% if latest_whole_num.status == 'SUCCESS' %}text-green-600
                        {% elif latest_whole_num.status == 'FAILED' %}text-red-600
                        {% else %}text-yellow-600{% endif %}">
                        {{ latest_whole_num.status }}
                    </span>
                </div>
                <p class="text-xs text-gray-400 mt-1">{{ latest_whole_num.start_time|date:"M d, Y H:i" }}</p>
            </div>
            {% endif %}
        </div>

        <!-- Success Rate Card -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-green-500 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Success Rate</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2">98%</p>
                    <p class="text-xs text-gray-500 mt-1">Last 30 Days</p>
                </div>
                <div class="bg-green-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-green-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
                    </svg>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200">
                <div class="w-full bg-gray-200 rounded-full h-2">
                    <div class="bg-green-600 h-2 rounded-full" style="width: 98%"></div>
                </div>
            </div>
        </div>

        <!-- Total Runs Card -->
        <div class="bg-white rounded-lg shadow-md p-6 border-l-4 border-purple-500 card-hover">
            <div class="flex items-center justify-between">
                <div>
                    <p class="text-gray-500 text-sm font-medium">Total Runs</p>
                    <p class="text-3xl font-bold text-gray-800 mt-2">{{ recent_logs|length }}</p>
                    <p class="text-xs text-gray-500 mt-1">Recent Executions</p>
                </div>
                <div class="bg-purple-100 rounded-full p-3">
                    <svg class="w-8 h-8 text-purple-600" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                    </svg>
                </div>
            </div>
            <div class="mt-4 pt-4 border-t border-gray-200">
                <p class="text-xs text-gray-500">
                    <span class="text-green-600 font-semibold">{{ recent_logs|length }}</span> successful runs
                </p>
            </div>
        </div>
    </div>

    <!-- Quick Actions -->
    <div class="bg-white rounded-lg shadow-md p-6 mb-8">
        <h2 class="text-xl font-bold text-gray-800 mb-4">Quick Actions</h2>
        <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
            <a href="{% url 'trading:camarilla_levels' %}" 
               class="flex flex-col items-center p-4 bg-gradient-to-br from-teal-50 to-teal-100 rounded-lg hover:shadow-lg transition-all duration-200">
                <svg class="w-10 h-10 text-teal-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" />
                </svg>
                <span class="text-sm font-semibold text-gray-700">View Camarilla</span>
            </a>
            
            <a href="{% url 'trading:whole_number' %}" 
               class="flex flex-col items-center p-4 bg-gradient-to-br from-blue-50 to-blue-100 rounded-lg hover:shadow-lg transition-all duration-200">
                <svg class="w-10 h-10 text-blue-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M7 12l3-3 3 3 4-4M8 21l4-4 4 4M3 4h18M4 4h16v12a1 1 0 01-1 1H5a1 1 0 01-1-1V4z" />
                </svg>
                <span class="text-sm font-semibold text-gray-700">Whole Numbers</span>
            </a>
            
            <a href="{% url 'trading:analytics' %}" 
               class="flex flex-col items-center p-4 bg-gradient-to-br from-purple-50 to-purple-100 rounded-lg hover:shadow-lg transition-all duration-200">
                <svg class="w-10 h-10 text-purple-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 8v8m-4-5v5m-4-2v2m-2 4h12a2 2 0 002-2V6a2 2 0 00-2-2H6a2 2 0 00-2 2v12a2 2 0 002 2z" />
                </svg>
                <span class="text-sm font-semibold text-gray-700">Analytics</span>
            </a>
            
            <a href="{% url 'trading:script_logs' %}" 
               class="flex flex-col items-center p-4 bg-gradient-to-br from-orange-50 to-orange-100 rounded-lg hover:shadow-lg transition-all duration-200">
                <svg class="w-10 h-10 text-orange-600 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                </svg>
                <span class="text-sm font-semibold text-gray-700">View Logs</span>
            </a>
        </div>
    </div>

    <!-- Add this to your dashboard.html after the Quick Actions section -->

<!-- Script Execution Panel -->
<div class="bg-white rounded-lg shadow-md p-6 mb-8">
    <h2 class="text-xl font-bold text-gray-800 mb-4">Script Execution</h2>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
        <!-- Camarilla Script -->
        <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-800">Camarilla Levels</h3>
                <span id="camarillaStatus" class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                    Not Run
                </span>
            </div>
            <p class="text-sm text-gray-600 mb-4">Calculate daily Camarilla trading levels</p>
            <button onclick="runCamarillaScript()"
                    class="w-full bg-teal-600 text-white py-2 px-4 rounded-md hover:bg-teal-700 transition-colors flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Run Camarilla Script
            </button>
            <div id="camarillaMessage" class="mt-2 text-sm"></div>
        </div>

        <!-- Whole Number Script -->
        <div class="border border-gray-200 rounded-lg p-4">
            <div class="flex items-center justify-between mb-3">
                <h3 class="text-lg font-semibold text-gray-800">Whole Number Detection</h3>
                <span id="wholeNumberStatus" class="px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800">
                    Not Run
                </span>
            </div>
            <p class="text-sm text-gray-600 mb-4">Detect stocks with whole number highs and lows</p>
            <button onclick="runWholeNumberScript()"
                    class="w-full bg-blue-600 text-white py-2 px-4 rounded-md hover:bg-blue-700 transition-colors flex items-center justify-center">
                <svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" />
                </svg>
                Run Whole Number Script
            </button>
            <div id="wholeNumberMessage" class="mt-2 text-sm"></div>
        </div>
    </div>
</div>

<script>
// Function to update script status
function updateScriptStatus() {
    fetch('/api/script-status/')
        .then(response => {
            if (!response.ok) {
                throw new Error('Network response was not ok');
            }
            return response.json();
        })
        .then(data => {
            // Update Camarilla status
            if (data.camarilla) {
                updateStatusElement('camarillaStatus', data.camarilla.status);
            }

            // Update Whole Number status
            if (data.whole_number) {
                updateStatusElement('wholeNumberStatus', data.whole_number.status);
            }
        })
        .catch(error => {
            console.error('Error fetching script status:', error);
        });
}

// Helper function to update status elements
function updateStatusElement(elementId, status) {
    const statusElement = document.getElementById(elementId);
    if (!statusElement) return;

    statusElement.textContent = status;

    // Update status color
    const statusClasses = {
        'SUCCESS': 'px-2 py-1 text-xs font-semibold rounded-full bg-green-100 text-green-800',
        'RUNNING': 'px-2 py-1 text-xs font-semibold rounded-full bg-yellow-100 text-yellow-800 animate-pulse',
        'FAILED': 'px-2 py-1 text-xs font-semibold rounded-full bg-red-100 text-red-800',
        'NOT_RUN': 'px-2 py-1 text-xs font-semibold rounded-full bg-gray-100 text-gray-800'
    };

    statusElement.className = statusClasses[status] || statusClasses['NOT_RUN'];
}

// Function to run Camarilla script
async function runCamarillaScript() {
    const button = event.target;
    const messageElement = document.getElementById('camarillaMessage');

    // Reset message
    messageElement.textContent = '';
    messageElement.className = 'mt-2 text-sm';

    button.disabled = true;
    button.innerHTML = '<svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v4m0 12v4m8-10h-4M6 12H2"/></svg> Running...';

    try {
        const csrftoken = getCookie('csrftoken');

        const response = await fetch('/api/run-camarilla/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.message || 'Failed to run script');
        }

        messageElement.textContent = data.message;
        messageElement.className = 'mt-2 text-sm ' + (data.status === 'success' ? 'text-green-600' : 'text-red-600');

        // Start polling for status updates
        setTimeout(updateScriptStatus, 2000);
        const statusInterval = setInterval(updateScriptStatus, 5000);

        // Stop polling after 2 minutes
        setTimeout(() => clearInterval(statusInterval), 120000);

    } catch (error) {
        console.error('Error:', error);
        messageElement.textContent = 'Error: ' + error.message;
        messageElement.className = 'mt-2 text-sm text-red-600';
    } finally {
        setTimeout(() => {
            button.disabled = false;
            button.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> Run Camarilla Script';
        }, 3000);
    }
}

// Function to run Whole Number script
async function runWholeNumberScript() {
    const button = event.target;
    const messageElement = document.getElementById('wholeNumberMessage');

    // Reset message
    messageElement.textContent = '';
    messageElement.className = 'mt-2 text-sm';

    button.disabled = true;
    button.innerHTML = '<svg class="w-5 h-5 mr-2 animate-spin" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 2v4m0 12v4m8-10h-4M6 12H2"/></svg> Running...';

    try {
        const csrftoken = getCookie('csrftoken');

        const response = await fetch('/api/run-whole-number/', {
            method: 'POST',
            headers: {
                'X-CSRFToken': csrftoken,
                'Content-Type': 'application/json',
            },
            body: JSON.stringify({})
        });

        const data = await response.json();

        if (!response.ok) {
            throw new Error(data.message || 'Failed to run script');
        }

        messageElement.textContent = data.message;
        messageElement.className = 'mt-2 text-sm ' + (data.status === 'success' ? 'text-green-600' : 'text-red-600');

        // Start polling for status updates
        setTimeout(updateScriptStatus, 2000);
        const statusInterval = setInterval(updateScriptStatus, 5000);

        // Stop polling after 2 minutes
        setTimeout(() => clearInterval(statusInterval), 120000);

    } catch (error) {
        console.error('Error:', error);
        messageElement.textContent = 'Error: ' + error.message;
        messageElement.className = 'mt-2 text-sm text-red-600';
    } finally {
        setTimeout(() => {
            button.disabled = false;
            button.innerHTML = '<svg class="w-5 h-5 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z" /></svg> Run Whole Number Script';
        }, 3000);
    }
}

// CSRF token helper function
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let i = 0; i < cookies.length; i++) {
            const cookie = cookies[i].trim();
            if (cookie.substring(0, name.length + 1) === (name + '=')) {
                cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                break;
            }
        }
    }

    // If still no cookie, try to get it from the meta tag
    if (!cookieValue) {
        const csrfTokenMeta = document.querySelector('meta[name="csrf-token"]');
        if (csrfTokenMeta) {
            cookieValue = csrfTokenMeta.getAttribute('content');
        }
    }

    return cookieValue;
}

// Update status on page load
document.addEventListener('DOMContentLoaded', function() {
    updateScriptStatus();
    // Update status every 30 seconds
    setInterval(updateScriptStatus, 30000);
});
</script>

    <!-- Recent Activity -->
    <div class="bg-white rounded-lg shadow-md p-6">
        <div class="flex items-center justify-between mb-4">
            <h2 class="text-xl font-bold text-gray-800">Recent Script Executions</h2>
            <a href="{% url 'trading:script_logs' %}" class="text-blue-600 hover:text-blue-800 text-sm font-medium">
                View All â†’
            </a>
        </div>
        
        <div class="overflow-x-auto">
            <table class="min-w-full divide-y divide-gray-200">
                <thead class="bg-gray-50">
                    <tr>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Script</th>
                        <th class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">Date & Time</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Status</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Records</th>
                        <th class="px-6 py-3 text-center text-xs font-medium text-gray-500 uppercase tracking-wider">Duration</th>
                    </tr>
                </thead>
                <tbody class="bg-white divide-y divide-gray-200">
                    {% for log in recent_logs %}
                    <tr class="hover:bg-gray-50 transition-colors">
                        <td class="px-6 py-4 whitespace-nowrap">
                            <span class="px-2 py-1 text-xs font-medium rounded-full
                                {% if log.script_name == 'CAMARILLA' %}bg-teal-100 text-teal-800
                                {% else %}bg-blue-100 text-blue-800{% endif %}">
                                {{ log.get_script_name_display }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap">
                            <div class="text-sm font-medium text-gray-900">{{ log.start_time|date:"M d, Y" }}</div>
                            <div class="text-xs text-gray-500">{{ log.start_time|time:"H:i:s" }} IST</div>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center">
                            <span class="px-2 py-1 text-xs font-medium rounded-full
                                {% if log.status == 'SUCCESS' %}bg-green-100 text-green-800
                                {% elif log.status == 'FAILED' %}bg-red-100 text-red-800
                                {% else %}bg-yellow-100 text-yellow-800{% endif %}">
                                {{ log.status }}
                            </span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm">
                            <span class="font-bold text-green-600">{{ log.records_success }}</span>
                            <span class="text-gray-400">/</span>
                            <span class="text-gray-700">{{ log.records_processed }}</span>
                        </td>
                        <td class="px-6 py-4 whitespace-nowrap text-center text-sm text-gray-500">
                            {% if log.duration_seconds %}{{ log.duration_seconds }}s{% else %}-{% endif %}
                        </td>
                    </tr>
                    {% empty %}
                    <tr>
                        <td colspan="5" class="px-6 py-8 text-center text-gray-500">
                            <svg class="w-12 h-12 mx-auto text-gray-300 mb-2" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z" />
                            </svg>
                            No logs available
                        </td>
                    </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>

    <!-- Info Section -->
    <div class="mt-8 grid grid-cols-1 md:grid-cols-2 gap-6">
        <div class="bg-blue-50 border-l-4 border-blue-500 p-6 rounded-lg">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-blue-600 mt-1 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <div>
                    <h3 class="text-lg font-semibold text-blue-900 mb-2">About Camarilla Levels</h3>
                    <p class="text-blue-800 text-sm leading-relaxed">
                        Camarilla levels are advanced pivot points that identify key support and resistance zones. They help traders make informed decisions about entry, exit, and stop-loss placements for intraday trading.
                    </p>
                </div>
            </div>
        </div>

        <div class="bg-purple-50 border-l-4 border-purple-500 p-6 rounded-lg">
            <div class="flex items-start">
                <svg class="w-6 h-6 text-purple-600 mt-1 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z" />
                </svg>
                <div>
                    <h3 class="text-lg font-semibold text-purple-900 mb-2">System Features</h3>
                    <p class="text-purple-800 text-sm leading-relaxed">
                        Automated daily calculations, email notifications, historical data tracking, and real-time monitoring ensure you never miss trading opportunities.
                    </p>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}
